//pipeline {
//    agent any
//
//    tools {
//        allure 'allure'
//    }
//
//    environment {
//        APP_NETWORK     = "application_messageboard-network"
//        REST_TEST_IMAGE = "messageboard-rest-tests"
//
//        ALLURE_ROOT     = "${WORKSPACE}/allure-results"
//        ALLURE_REPORT   = "${WORKSPACE}/allure-report"
//    }
//
//    stages {
//
//        stage('Build application images') {
//            steps {
//                dir("pipelines/application") {
//                    sh 'docker compose build'
//                }
//            }
//        }
//
//        stage('Start application stack') {
//            steps {
//                dir("pipelines/application") {
//                    sh 'docker compose up -d'
//                }
//            }
//        }
//
//        stage('Build REST-Assured test image') {
//            steps {
//                dir("pipelines/rest-assured") {
//                    sh "docker build -t ${REST_TEST_IMAGE} ."
//                }
//            }
//        }
//
//        stage('Run Integration Tests') {
//            steps {
//                sh '''
//                  set -e
//
//                  docker rm -f rest-tests-integration || true
//                  rm -rf allure-results/integration
//                  mkdir -p allure-results/integration
//
//                  docker run --name rest-tests-integration \
//                    --network ${APP_NETWORK} \
//                    ${REST_TEST_IMAGE} \
//                    mvn -B -Dtest=IntegrationTest test
//
//                  docker cp \
//                    rest-tests-integration:/tests/target/allure-results/. \
//                    allure-results/integration/
//
//                  docker rm -f rest-tests-integration
//                '''
//            }
//        }
//
//        stage('Run E2E Tests') {
//            steps {
//                sh '''
//                  set -e
//
//                  docker rm -f rest-tests-e2e || true
//                  rm -rf allure-results/e2e
//                  mkdir -p allure-results/e2e
//
//                  docker run --name rest-tests-e2e \
//                    --network ${APP_NETWORK} \
//                    ${REST_TEST_IMAGE} \
//                    mvn -B -Dtest=e2eTest test
//
//                  docker cp \
//                    rest-tests-e2e:/tests/target/allure-results/. \
//                    allure-results/e2e/
//
//                  docker rm -f rest-tests-e2e
//                '''
//            }
//        }
//
//        stage('Publish Allure Report') {
//            steps {
//                archiveArtifacts artifacts: 'allure-results/**', fingerprint: true
//
//                allure(
//                        includeProperties: false,
//                        jdk: '',
//                        results: [
//                                [path: 'allure-results/integration'],
//                                [path: 'allure-results/e2e']
//                        ]
//                )
//            }
//        }
//
//        stage('Send Slack Notification') {
//            steps {
//                withCredentials([string(credentialsId: 'SLACK_WEBHOOK', variable: 'SLACK_WEBHOOK_URL')]) {
//                    dir('pipelines/scripts') {
//                        sh '''
//                          chmod +x slack.sh
//                          export SLACK_WEBHOOK_URL="$SLACK_WEBHOOK_URL"
//                          export ALLURE_REPORT_DIR="${ALLURE_REPORT}"
//                          ./slack.sh
//                        '''
//                    }
//                }
//            }
//        }
//    }
//
//    post {
//        always {
//            archiveArtifacts artifacts: 'allure-results/**, allure-report/**', fingerprint: true
//
//            dir("pipelines/application") {
//                sh 'docker compose down -v'
//            }
//        }
//
//        failure {
//            echo "Pipeline failed"
//        }
//    }
//}
def runTestsAndCollectAllure(String containerName, String testSelector, String resultsDir) {
    sh """
      set -e

      docker rm -f ${containerName} || true
      rm -rf ${resultsDir}
      mkdir -p ${resultsDir}

      docker run --name ${containerName} \
        --network ${APP_NETWORK} \
        ${REST_TEST_IMAGE} \
        mvn -B -Dtest=${testSelector} test

      docker cp \
        ${containerName}:/tests/target/allure-results/. \
        ${resultsDir}/

      docker rm -f ${containerName}
    """
}

pipeline {
    agent any

    tools {
        allure 'allure'
    }

    environment {
        APP_NETWORK     = "application_messageboard-network"
        REST_TEST_IMAGE = "messageboard-rest-tests"

        ALLURE_ROOT     = "${WORKSPACE}/allure-results"
        ALLURE_REPORT   = "${WORKSPACE}/allure-report"
    }

    stages {

        stage('Build application images') {
            steps {
                dir("pipelines/application") {
                    sh 'docker compose build'
                }
            }
        }

        stage('Start application stack') {
            steps {
                dir("pipelines/application") {
                    sh 'docker compose up -d'
                }
            }
        }

        stage('Build REST-Assured test image') {
            steps {
                dir("pipelines/rest-assured") {
                    sh "docker build -t ${REST_TEST_IMAGE} ."
                }
            }
        }

        stage('Run Integration Tests') {
            steps {
                script {
                    runTestsAndCollectAllure(
                            "rest-tests-integration",
                            "IntegrationTest",
                            "allure-results/integration"
                    )
                }
            }
        }

        stage('Run E2E Tests') {
            steps {
                script {
                    runTestsAndCollectAllure(
                            "rest-tests-e2e",
                            "e2eTest",
                            "allure-results/e2e"
                    )
                }
            }
        }

        stage('Publish Allure Report') {
            steps {
                archiveArtifacts artifacts: 'allure-results/**', fingerprint: true

                allure(
                        includeProperties: false,
                        jdk: '',
                        results: [
                                [path: 'allure-results/integration'],
                                [path: 'allure-results/e2e']
                        ]
                )
            }
        }

        stage('Send Slack Notification') {
            steps {
                withCredentials([string(credentialsId: 'SLACK_WEBHOOK', variable: 'SLACK_WEBHOOK_URL')]) {
                    dir('pipelines/scripts') {
                        sh '''
                          export SLACK_WEBHOOK_URL="$SLACK_WEBHOOK_URL"
                          export ALLURE_REPORT_DIR="${ALLURE_REPORT}"
                          ./slack.sh
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'allure-results/**, allure-report/**', fingerprint: true

            dir("pipelines/application") {
                sh 'docker compose down -v'
            }
        }

        failure {
            echo "Pipeline failed"
        }
    }
}
